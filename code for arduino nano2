#include <Wire.h>
#include <SPI.h>
#include <LoRa.h>

int nano1 = 0;
int nano2 = 1;
int nano3 = 2;

int a = 0; 
int d = 0 ;
float N = 0 ;
float D1 = 0 ; 
float D2 = 0 ;
float D3 = 0 ;
float x = 0;
float y = 0;
float Circle = 0;
const int buzzer = 3;
int degree = 0;

int desX = 2;
int desY = 7;

void setup() { 
  Wire.begin(nano2);
  Wire.onReceive(receiveEvent);
  Serial.begin(9600);

  pinMode(buzzer, OUTPUT);
  
  while (!Serial);
  Serial.println("LoRa Receiver");
  if (!LoRa.begin(433E6)) {
    Serial.println("Starting LoRa failed!");
    while (1);
  }
}

void loop() {}

 

void receiveEvent( int howMany){
   int c = Wire.read();
    Serial.println(c);

   if (c <= 64 && c >= 1){
   if (c <= 8 && c >= 1 ){
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW);    
  delay(100000); 
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW);  

}
   if (c <= 64 && c >= 56 ){
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW);    
  delay(100000); 
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW);  

}
   if (c <= 16 && c >= 9 ){
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW);    
  delay(100000); 
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000);
}
   if (c <= 55 && c >= 32 ){
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000);
  delay(100000); 
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW);  
}
   if (c <= 31 && c >= 17 ){
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000);
  delay(100000); 
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000);
}
   }
  if (c <= 128 && c >= 65){
     int packetSize = LoRa.parsePacket();
  int Rssi = LoRa.packetRssi();
  float Z = -18.8;
  float X = 9.11;
    
  if (packetSize) { 
    Serial.print("Packet ");
    while (LoRa.available()) {
      int READ = LoRa.read();
      Serial.print(READ);
      Serial.print(" ");

    if (READ == 53){
        Serial.print("NO. 1 ");
        Serial.print(" with RSSI ");
        Serial.print(Rssi);
        Serial.print(" ");
        float ARN = ((Z-Rssi)/(10*X)) ;
        D1 = pow(10,ARN);
        Serial.println(D1);
    }
    
    if (READ == 50){
        Serial.print("NO. 2 ");
        Serial.print(" with RSSI ");
        Serial.print(Rssi);
        Serial.print(" ");
        float ARN = ((Z-Rssi)/(10*X)) ;
        D3 = pow(10,ARN);
        Serial.println(D3);
    }

    if (READ == 51){ 
        Serial.print("NO. 3 ");
        Serial.print(" with RSSI ");
        Serial.print(Rssi);
        Serial.print(" ");
        float ARN = ((Z-Rssi)/(10*X)) ;
        D2 = pow(10,ARN);
        Serial.println(D2);
    }

// d1 d2 = 7.2 m
// d2 d3 = 7.2 m
// d1 d4 = 1 m
  Serial.print(D1);
  Serial.print("  ");
  Serial.print(D2);
  Serial.print("  ");
  Serial.print(D3);
  
  x = (pow(D2,2)-pow(D1,2)-pow(7.2,2))/-14.4;

  Serial.print(" X: ");
  Serial.print(x);
  
  y = (pow(D3,2)-pow(D2,2)-pow(7.2,2))/-14.4;
  Serial.print(" Y: ");
  Serial.println(y);

  }
  }


  if (x <= desX && y <= desY){
    d = sqrt(pow(x-desX,2)+pow(y-desY,2));
    degree =asin(abs(x - desX)/d);
    degree = degree*180/3.14;
    degree = degree*64/360;
    degree = degree + 64;
    Serial.print(degree);
        Serial.println("HeHe1");
    }
  if (x <= desX && y >= desY){
    d = sqrt(pow(x-desX,2)+pow(y-desY,2));
    degree =acos(abs(x - desX)/d);
    degree = degree*180/3.14;
    degree = degree + 90;
    degree = degree*64/360;
    degree = degree + 64;
        Serial.print(degree);
        Serial.println("HeHe2");
    }
  if (x >= desX && y >= desY){
    d = sqrt(pow(x-desX,2)+pow(y-desY,2));
    degree =asin(abs(x - desX)/d);
    degree = degree*180/3.14;
    degree = degree + 180;
    degree = degree*64/360;
    degree = degree + 64;
        Serial.print(degree);
        Serial.println("HeHe3");
    }
  if (x >= desX && y <= desY){
    d = sqrt(pow(x-desX,2)+pow(y-desY,2));
    degree =acos(abs(x - desX)/d);
    degree = degree*180/3.14;
    degree = degree + 270;
    degree = degree*64/360;
    degree = degree + 64;
        Serial.print(degree);
    Serial.println("HeHe4");
    }

   if (c <= degree+2 && c >= degree-2 ){
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW);    
  delay(100000); 
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW);  

}
   if (c <= degree+8 && c >= degree+3 ){
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW);    
  delay(100000); 
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000);
}
   if (c <= degree-3 && c >= degree-8 ){
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000);
  delay(100000); 
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000); digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW);  
}
   if (c <= degree-9 && c >= degree+9 ){
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000);
  delay(100000); 
  digitalWrite(buzzer, HIGH); delay(1000); digitalWrite(buzzer, LOW); delay(1000);
}
    } 
  return D1;
  return D2;
  return D3; 
}
